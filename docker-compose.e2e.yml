# Docker Compose configuration for E2E (Playwright/Chromium) testing.
# Starts backend + frontend with a clean database, then runs Playwright tests.
#
# Usage:
#   docker compose -f docker-compose.e2e.yml up --build --abort-on-container-exit
#
# Or via Makefile:
#   make test-e2e

services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    environment:
      - DATABASE_URL=sqlite:///./data/codex_system.db
      - SECRET_KEY=e2e-test-secret-key-not-for-production
      - DEBUG=false
      - LOG_LEVEL=WARNING
      - PYTHONUNBUFFERED=1
      - CODEX_PLUGINS_DIR=/app/plugins
    volumes:
      - e2e-data:/app/data
      - ./plugins:/app/plugins
    command: >
      sh -c "alembic upgrade head && python -m codex.main"
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 5s
      timeout: 5s
      retries: 15
      start_period: 10s

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - VITE_API_BASE_URL=/api
    depends_on:
      backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:80"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 5s

  playwright:
    build:
      context: ./e2e
      dockerfile: Dockerfile
    depends_on:
      frontend:
        condition: service_healthy
    environment:
      - BASE_URL=http://frontend:80
      - CI=true
    volumes:
      - ./e2e/test-results:/app/test-results
      - ./e2e/playwright-report:/app/playwright-report
    command: npx playwright test --reporter=list

volumes:
  e2e-data:
