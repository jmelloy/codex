# Development overrides for docker-compose
# Copy this file to docker-compose.override.yml to enable development mode
#
# Usage:
#   cp docker-compose.override.yml.example docker-compose.override.yml
#   cp .env.example .env
#   docker compose up
#
# Docker Compose automatically merges docker-compose.override.yml with docker-compose.yml

services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
      target: builder  # Use builder stage for dev (includes all deps)
    environment:
      - DATABASE_URL=sqlite:///./data/codex_system.db
      - SECRET_KEY=dev-secret-key-not-for-production
      - DEBUG=true
    volumes:
      # Mount source code for hot-reloading
      - ./backend:/app/backend:ro
      - ./data:/app/data
    command: uvicorn backend.api.main:app --host 0.0.0.0 --port 8000 --reload
    # Disable health check in dev for faster startup
    healthcheck:
      disable: true
    restart: "no"

  # Override frontend to disable in dev (use frontend-dev instead)
  frontend:
    profiles:
      - production-only

  # Development frontend with hot-reloading
  frontend-dev:
    image: node:22-slim
    working_dir: /app
    ports:
      - "${FRONTEND_DEV_PORT:-5174}:5173"
    volumes:
      - ./frontend:/app
      - frontend-node-modules:/app/node_modules
    command: sh -c "npm install && npm run dev -- --host 0.0.0.0"
    environment:
      - VITE_API_BASE_URL=http://localhost:${BACKEND_PORT:-8765}
    stdin_open: true
    tty: true
    depends_on:
      - backend

volumes:
  frontend-node-modules:
